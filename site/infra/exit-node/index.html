<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      // Hack for scrolling window when linking to anchor tag with fixed nav header
      var shiftWindow = function() { scrollBy(0, -75) };
      window.addEventListener("hashchange", shiftWindow);
      function load() { if (window.location.hash) shiftWindow(); }
    </script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="PKT">
    <link rel="canonical" href="https://docs.pkt.cash/infra/exit-node/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    
    <title>Setup a VPN Exit Node - PKT Documentation</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet">
    <link href="../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../css/code-styles.css" rel="stylesheet">
    <link href="../../css/mega-menu.css" rel="stylesheet">
    <link href="../../css/code-tabs.css" rel="stylesheet">
    <link href="../../css/admonition.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="../../fonts.js"></script> 
  </head>
  
  <body class="" data-spy="scroll" data-target="#toc">
    <nav id="mainnav" class="navbar navbar-default navbar-expand-md sticky-top py-2" role="navigation">
  <div class="container">
    <a class="navbar-brand" href="../.." title="PKT Documentation">
      <img src="../../assets/logo.svg" alt="PKT Documentation">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainnav-navbar-collapse" aria-controls="mainnav-navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"><i class="fa fa-bars"></i></span>
    </button>
    <div id="mainnav-navbar-collapse" class="collapse navbar-collapse">
      <ul class="nav navbar-nav ml-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Learn</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="https://pkt.cash/mine" target="_blank">Mine</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/utility" target="_blank">Utility</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/pkt-network" target="_blank">PKT Network</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/pkt-cash" target="_blank">PKT Cash</a></li>
            <li><a class="dropdown-item" href="https://docsend.com/view/ayf5d3tz5rymn8fv" target="_blank">PKT Deck</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Develop</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="https://pkt.cash/developer-central" target="_blank">Developer Central</a></li>
            <li><a class="dropdown-item" href="https://docs.pkt.cash/" target="_blank">Technical Docs</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/roadmap" target="_blank">Roadmap</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/PacketCrypt-2020-09-04.pdf" target="_blank">Yellowpaper</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/PKT_Network_v1.0_2021.02.01.pdf" target="_blank">Whitepaper</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Network</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="https://pkt.cash/network-steward" target="_blank">Network Steward</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/wallet" target="_blank">Wallets</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/ecosystem" target="_blank">Ecosystem</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/cryptoeconomics" target="_blank">Cryptoeconomics</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/cjdns" target="_blank">Cjdns</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Explore</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="https://packetscan.io/" target="_blank">Explorer</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/community" target="_blank">Community</a></li>
            <li><a class="dropdown-item" href="https://crypto.pkt.cash/" target="_blank">Blog</a></li>
            <li><a class="dropdown-item" href="https://pkt.cash/brand" target="_blank">Media Kit</a></li>
          </ul>
        </li>
      </ul>
      
      <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex search_wrap">
        <li class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
	    <i class="fa fa-search"></i> Search
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div id="content"class="container">
      
    <div class="row">
      <div id="sidebar-nav" class="sidebar col-md-3"><nav id="sidenav" class="navbar navbar-default navbar-expand-md" role="navigation">
  <button class="navbar-toggler ml-auto hidden-sm-up" type="button" data-toggle="collapse" data-target="#sidebar-navbar-collapse" aria-controls="sidebar-navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"><i class="fa fa-bars fa-fw"></i></span>
  </button>
  <div class="collapse navbar-collapse" id="sidebar-navbar-collapse">
    <!-- Main navigation -->
    <ul class="nav navbar-nav flex-column">
      <li >
        <a class="toplevel nav-link" href="../..">Home</a>
      </li>
      <li class="toplevel nav-item" data-toggle="collapse" data-target="#pkt-network">
        <!--<a href="#" class="nav-link">PKT Network <b class="caret"></b></a>-->
        <span class="section-title">PKT Network</span>
        <ul id="pkt-network" class="collapse">
                
<li>
    <a href="../../network/what-is-network/" class="md-nav__link ">What is PKT Network</a>
</li>
                
<li>
    <a href="../../network/open-ecosystem/" class="md-nav__link ">An Open Ecosystem</a>
</li>
        </ul>
      </li>
      <li class="toplevel nav-item" data-toggle="collapse" data-target="#staking">
        <!--<a href="#" class="nav-link">Staking <b class="caret"></b></a>-->
        <span class="section-title">Staking</span>
        <ul id="staking" class="collapse">
                
<li>
    <a href="../../stake/stake-earn/" class="md-nav__link ">Stake to earn</a>
</li>
                
<li>
    <a href="../../stake/how-to/" class="md-nav__link ">How to stake</a>
</li>
                
<li>
    <a href="../../stake/community-liquidity/" class="md-nav__link ">Community Liquidity</a>
</li>
                
<li>
    <a href="../../stake/stake-lp/" class="md-nav__link ">How to stake LP</a>
</li>
                
<li>
    <a href="../../stake/stake-lp-tokens/" class="md-nav__link ">How to stake LP tokens</a>
</li>
        </ul>
      </li>
      <li >
        <a class="toplevel nav-link" href="../../airdrop/">Migration airdrop</a>
      </li>
      <li class="toplevel nav-item active" data-toggle="collapse" data-target="#infrastructure">
        <!--<a href="#" class="nav-link">Infrastructure <b class="caret"></b></a>-->
        <span class="section-title">Infrastructure</span>
        <ul id="infrastructure" class="collapse">
                
<li>
    <a href="../infrastructure/" class="md-nav__link ">Infrastructure</a>
</li>
                
<li>
    <a href="../vpn-exit/" class="md-nav__link ">VPN Exit</a>
</li>
                
<li>
    <a href="../cjdns-node/" class="md-nav__link ">Setup a Cjdns Node</a>
</li>
                
<li>
    <a href="../vpn/" class="md-nav__link ">PKT VPN</a>
</li>
                
<li>
    <a href="./" class="md-nav__link  active">Setup a VPN Exit Node</a>
</li>
                
<li>
    <a href="../domain-node/" class="md-nav__link ">Setup a Domain Node</a>
</li>
                
<li>
    <a href="../nameserver/" class="md-nav__link ">Setup a Nameserver Node</a>
</li>
                
<li>
    <a href="../route-server/" class="md-nav__link ">Setup a Route Server Node</a>
</li>
                
<li>
    <a href="../build-web/" class="md-nav__link ">Build a Website in PKT Network</a>
</li>
                
<li>
    <a href="../cjdns-web/" class="md-nav__link ">Accessing your cjdns website</a>
</li>
        </ul>
      </li>
      <li class="toplevel nav-item" data-toggle="collapse" data-target="#tokenomics">
        <!--<a href="#" class="nav-link">Tokenomics <b class="caret"></b></a>-->
        <span class="section-title">Tokenomics</span>
        <ul id="tokenomics" class="collapse">
                
<li>
    <a href="../../tokenomics/introduction/" class="md-nav__link ">Tokenomics</a>
</li>
                
<li>
    <a href="../../tokenomics/initial-distribution/" class="md-nav__link ">Initial Distribution</a>
</li>
                
<li>
    <a href="../../tokenomics/migration-airdrop/" class="md-nav__link ">Migration Airdrop</a>
</li>
                
<li>
    <a href="../../tokenomics/token-supply/" class="md-nav__link ">Token Supply</a>
</li>
                
<li>
    <a href="../../tokenomics/burned-coin-recapture-reconciliation/" class="md-nav__link ">Burned Coin Recapture Reconciliation</a>
</li>
                
<li>
    <a href="../../tokenomics/proof-of-stake-voting/" class="md-nav__link ">Proof-of-Stake Voting</a>
</li>
                
<li>
    <a href="../../tokenomics/dev-team/" class="md-nav__link ">Development Team Allocation</a>
</li>
        </ul>
      </li>
      <li >
        <a class="toplevel nav-link" href="../../affiliate/">Affiliate</a>
      </li>
      <li >
        <a class="toplevel nav-link" href="../../buy-pkt-on-base/">How to buy PKT</a>
      </li>
      <li >
        <a class="toplevel nav-link" href="../../wallets/">Wallets</a>
      </li>
      <li class="toplevel nav-item" data-toggle="collapse" data-target="#utility">
        <!--<a href="#" class="nav-link">Utility <b class="caret"></b></a>-->
        <span class="section-title">Utility</span>
        <ul id="utility" class="collapse">
                
<li>
    <a href="../../utility/" class="md-nav__link ">Introduction</a>
</li>
                
<li>
    <a href="../../utility/content/" class="md-nav__link ">Content & Media</a>
</li>
                
<li>
    <a href="../../utility/bia/" class="md-nav__link ">BIA</a>
</li>
                
<li>
    <a href="../../utility/ecommerce/" class="md-nav__link ">Ecommerce</a>
</li>
                
<li>
    <a href="../../utility/markets/" class="md-nav__link ">Bandwidth Markets</a>
</li>
                
<li>
    <a href="../../utility/transparency/" class="md-nav__link ">Payments Transparency</a>
</li>
        </ul>
      </li>
      <li class="toplevel nav-item" data-toggle="collapse" data-target="#governance">
        <!--<a href="#" class="nav-link">Governance <b class="caret"></b></a>-->
        <span class="section-title">Governance</span>
        <ul id="governance" class="collapse">
                
<li>
    <a href="../../governance/" class="md-nav__link ">Introduction</a>
</li>
                
<li>
    <a href="../../governance-nsc/" class="md-nav__link ">Network Steward Charter</a>
</li>
        </ul>
      </li>
      <li class="toplevel nav-item" data-toggle="collapse" data-target="#community">
        <!--<a href="#" class="nav-link">Community <b class="caret"></b></a>-->
        <span class="section-title">Community</span>
        <ul id="community" class="collapse">
                
<li>
    <a href="../../community/code_of_conduct/" class="md-nav__link ">Code of Conduct</a>
</li>
                
<li>
    <a href="../../community/ethica-communication-guidelines/" class="md-nav__link ">Ethical Communication Guidelines</a>
</li>
                
<li>
    <a href="../../community/avoid-examples/" class="md-nav__link ">Examples to Avoid</a>
</li>
                
<li>
    <a href="../../community/better-examples/" class="md-nav__link ">Better Examples</a>
</li>
        </ul>
      </li>
      <li >
        <a class="toplevel nav-link" href="../../community/press-media-assets/">Brand Assets</a>
      </li>
    </ul>
  </div>
</nav>
</div>
      <div id="main" class="col-md-7" role="main">
        


<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    
    
    <li class="breadcrumb-item">Infrastructure</li>
    
    
    <li class="breadcrumb-item active" aria-current="page">Setup a VPN Exit Node</li>
  </ol>
</nav>


<h1 id="setup-a-vpn-exit-node">Setup a VPN Exit Node</h1>
<p>This guide will help you set up a CJDNS node with PKT wallet and the following services: You can follow the <a href="/infra/vpn-exit/">steps</a> to set up the server or read more about the process and <a href="/infra/vpn/">services</a> involved.</p>
<ul>
<li><a href="https://github.com/anode-co/anodevpn-server" target="_blank">AnodeVPN server</a></li>
<li><a href="https://github.com/hwdsl2/setup-ipsec-vpn" target="_blank">IKEv2 Ipsec VPN server</a></li>
<li><a href="https://ubuntu.com/server/docs/how-to-install-and-use-openvpn" target="_blank">OpenVPN server</a></li>
<li><a href="https://github.com/dlundquist/sniproxy" target="_blank">SNI proxy</a></li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Requirements</p>
<ul>
<li>A server running debian based Linux (preferably Ubuntu 22.04)</li>
<li>Install docker</li>
</ul>
</div>
<p>https://docs.docker.com/engine/install/ubuntu/ * Install jq</p>
<pre><code class="language-console">sudo apt-get install jq
</code></pre>
<h2 id="steps">Steps</h2>
<ul>
<li>
<p>Create a data directory where the server configuration will be stored.</p>
<p><code>console
mkdir vpn_data</code></p>
</li>
<li>
<p>Configure the server by running the following command:</p>
<p><code>console
docker run -it --rm -v $(pwd)/vpn_data:/data pkteer/pkt-server /configure.sh</code></p>
</li>
<li>
<p>Configure various service by running the following command:</p>
<p><code>console
./vpn_data/setup.sh</code></p>
<p>The script will prompt you to set up various flags and values needed for setting up the services the first time.</p>
</li>
<li>
<p>Run the server by running the following commands:</p>
<p><code>console
./vpn_data/start-vpn.sh</code></p>
<div class="admonition info">
<p class="admonition-title">NOTE</p>
<p>It can take a few minutes on the first run for the server to set up all the services.</p>
</div>
</li>
</ul>
<h2 id="monitoring-the-server">Monitoring the server</h2>
<p>You can view the progress of the server by running:</p>
<pre><code class="language-console">docker logs -f pkt-server
</code></pre>
<p>You can also check the status of all services by running:</p>
<pre><code class="language-console">./vpn_data/status.sh
</code></pre>
<p>or using the AnodeVPN API:</p>
<pre><code class="language-console">http://[server]:8099/api/0.4/server/status/
</code></pre>
<h2 id="understanding-the-process">Understanding the process</h2>
<h3 id="configuration">Configuration</h3>
<p>The <code>configure.sh</code> script is designed to set up and configure the server environment. Below is a detailed explanation of its functionality:</p>
<h4 id="initialization-and-default-values">Initialization and Default Values:</h4>
<p>The script initializes several flags and variables with default values: </p>
<ul>
<li><strong>no_vpn_flag</strong>: Indicates whether VPN should be disabled (default: false). </li>
<li><strong>cjdns_flag</strong>: Indicates whether CJDNS should be enabled (default: true). </li>
<li><strong>with_pktd_flag</strong>: Indicates whether PKTD should be enabled (default: false). </li>
<li><strong>pktd_passwd</strong>: Stores the PKTD password (default: empty). </li>
<li><strong>pktd_user</strong>: Stores the PKTD username (default: "x").</li>
</ul>
<h4 id="configuration-file-handling">Configuration File Handling:</h4>
<p>The script checks if the configuration file <code>/data/config.json</code> exists. If it does, it reads the existing configuration; otherwise, it copies a template configuration from <code>/server/config.json</code> to <code>/data/config</code>.json.</p>
<h4 id="configuration-synchronization">Configuration Synchronization:</h4>
<p>If the configuration file exists, the script ensures that all fields from the template configuration are present in the existing configuration. Missing fields are added with their default values from the template.</p>
<h4 id="flag-parsing">Flag Parsing:</h4>
<p>The script parses command-line arguments to set various flags: </p>
<ul>
<li><strong>--no-vpn</strong>: Disables VPN. </li>
<li><strong>--with-pktd</strong>: Enables PKTD. </li>
<li><strong>--pktd-passwd=</strong>: Sets the PKTD password.</li>
</ul>
<h4 id="configuration-modification">Configuration Modification:</h4>
<p>Based on the parsed flags, the script modifies the configuration: Sets the VPN exit status based on <em>no_vpn_flag</em>. Enables or disables PKTD based on <em>with_pktd_flag</em>. Generates a random PKTD password if none is provided. Updates the PKTD username and password in the configuration.</p>
<h4 id="pkt-wallet-initialization">PKT Wallet Initialization:</h4>
<p>Starts the PKT Wallet daemon and checks if a wallet already exists. If not, it creates a new wallet and unlocks it.</p>
<h4 id="vpn-server-configuration">VPN Server Configuration:</h4>
<p>Retrieves the PKT Wallet secret for the VPN server and ensures the <code>cjdroute.conf</code> configuration file is valid. If the file does not exist, it generates a new one and seeds it with the retrieved secret.</p>
<h4 id="security-configuration">Security Configuration:</h4>
<p>Modifies the cjdroute.conf file to set specific security parameters.</p>
<h4 id="script-deployment">Script Deployment:</h4>
<p>Finally it copies several utility scripts from the server directory to the data directory for further use.</p>
<h3 id="initialization">Initialization</h3>
<p>The <code>init.sh</code> starts everytime the docker container is launched and is responsible for setting up and initializing various services and configurations on the server.</p>
<ol>
<li><strong>Server Configuration Check</strong>: It first checks if the server has already been configured by looking if cjdroute.conf exists. If the file is not found, the script exits.</li>
<li><strong>User Creation</strong>: It creates two users, cjdns and speedtest. They are used for running the cjdns and speed-test (iperf3) services, respectively.</li>
<li><strong>Configuration Updates</strong>: It reads the config.json configuration file and updates several configuration settings related to different services.</li>
<li><strong>PKT Wallet Initialization</strong>: It starts the PKT Wallet service and checks if a wallet already exists. If the wallet exists, it attempts to unlock it. If the unlock request times out, it restarts the wallet service.</li>
<li><strong>Cjdns Service</strong>: If cjdns is enabled, it sets up the necessary environment and starts the cjdns service. It also configures network settings and firewall rules to allow cjdns to function properly.</li>
<li><strong>PKTD Service</strong>: If PKTD is enabled, it constructs and runs the command to start the PKTD service with the appropriate configuration.</li>
<li><strong>Network Interface Check</strong>: It waits for tun0 network interface that is expected to be created by cjdroute to become available and then sets up firewall rules for network traffic.</li>
<li><strong>NFTables Initialization</strong>: It initializes NFTables, which is a framework for packet filtering and network address translation.</li>
<li><strong>VPN Server</strong>: If the VPN server is enabled, it starts the VPN server and sets up the pricing for the VPN service.</li>
<li><strong>Speed Test Service</strong>: It sets up the environment for running speed tests and starts the necessary services.</li>
<li><strong>Cjdns Peers</strong>: It adds peers for the cjdns network, the peers used are set in <code>/server/cjdnspeers.json</code> file.</li>
<li><strong>IKEv2 and OpenVPN</strong>: If IKEv2 or OpenVPN are enabled, it runs the respective configuration scripts to set up these VPN services.</li>
<li><strong>Node Exporter</strong>: It starts the Node Exporter service for Prometheus monitoring.</li>
<li><strong>SNI Proxy</strong>: If SNI Proxy is enabled, it starts the SNI Proxy service.</li>
<li><strong>Cron Job for Payments</strong>: It adds a cron job to handle payments on a weekly basis.</li>
<li><strong>Watchdog Service</strong>: If cjdns is enabled, it starts a watchdog service to monitor and maintain the cjdns service the AnodeVPN server and other services depending on the configuration of the server.</li>
<li><strong>Keep-Alive</strong>: Finally, it keeps the container running indefinitely by tailing <code>/dev/null</code>.</li>
</ol>
<h3 id="monitoring-with-watchdog">Monitoring with watchdog</h3>
<p>The <code>watchdog.sh</code> is monitoring the cjdroute service and if it stops it will restart it, when the cjdroute is restarted the AnodeVPN server is also restarted.</p>
<p>It will also check for the <code>pluto</code> service which is the IKEv2 Ipsec VPN server and if it stops it will restart it. Similarly for the <code>openvpn</code> service.</p>
<p>Finally the watchdog also checks the validity of vpnclients created by the AnodeVPN server and if their time has expired it will remove them.</p>
<h3 id="checking-the-status">Checking the status</h3>
<p>You can check the status of the services at any time either by running </p>
<pre><code>```console
vpn_data/status.sh
```
</code></pre>
<p>or by using the AnodeVPN API:</p>
<pre><code>```console
http://[server]:8099/api/0.4/server/status/
```
</code></pre>
<p>Next to each service you will see the process id if that service is running, otherwise it will be <code>0</code>. e.g.</p>
<pre><code>{
    "hostname": "kraut2.pkteer.com",
    "pktwallet": 67,
    "cjdns": 82,
    "anodeserver": 114,
    "ikev2": 4012,
    "openvpn": 4135,
    "watchdog": 4116,
    "date_time": "2024-07-17 10:08:19"
}
</code></pre>
<h2 id="understanding-the-services-and-files">Understanding the services and files</h2>
<h3 id="launching-the-server">Launching the server</h3>
<p>The <code>vpn_data/start-vpn.sh</code> and <code>vpn_data/start.sh</code> scripts are designed to set up and run a VPN server using Docker. Here's a step-by-step explanation of what the script does:</p>
<ul>
<li><strong>Environment Setup</strong>: It checks for the presence of necessary commands (jq, dirname, and docker). If any of these commands are missing, the script exits with an error message.</li>
<li><strong>Directory Navigation</strong>: It changes the working directory to the location of the script.</li>
<li><strong>Cjdns Port Extraction</strong>: It reads the cjdroute.conf file to extract the port number used by the cjdjns service. If the port number is not found in the expected format, it attempts to extract it using an alternative method.</li>
<li><strong>Configuration Reading</strong>: It reads the config.json file to get the region and city information. If either the region or city is not specified, the script exits with an error message.</li>
<li><strong>Cjdns RPC Port Setup</strong>: If the cjdns RPC (Remote Procedure Call) is enabled, it extracts the RPC port from the cjdroute.conf file and updates the configuration to expose the RPC port.</li>
<li><strong>Docker Container Execution</strong>: It runs a Docker container with various configurations:</li>
</ul>
<p>Sets the timezone based on the region and city defined in <code>vpn_data/config.json</code>. Configures logging, network capabilities, and device access. Sets system control parameters for IPv6 and IPv4 forwarding. Maps several ports for different services: </p>
<ul>
<li>reads the CJDNS port from the cjdroute.conf file and maps it to the host. </li>
<li>5201 port for the speed-test (iperf3) service. </li>
<li>64764 to the host for pktd service. </li>
<li>443 for the SNI Proxy service. </li>
<li>80 for the SNI Proxy service. </li>
<li>500 for the IKEv2 Ipsec VPN server (pluto service). </li>
<li>4500 for the IKEv2 Ipsec VPN server (pluto service). </li>
<li>943 for the OpenVPN server. </li>
<li>1194 for the OpenVPN server.</li>
</ul>
<p>Mounts necessary directories for data persistency and configuration files. </p>
<ul>
<li>/etc/openvpn to vpn_data/openvpn. </li>
<li>/server/vpnclients to vpn_data/vpnclients. </li>
<li>/data to vpn_data where the configuration files are stored, <code>cjdroute.conf</code> and <code>config.json</code> and others. </li>
</ul>
<p>Optionally maps the CJDNS RPC port if it is enabled. Runs the container in detached mode with elevated privileges. The script ensures that all necessary configurations are in place and starts the VPN server within a Docker container, making it ready for use.</p>
<h3 id="cjdns">Cjdns</h3>
<p>Cjdns is running on the server using a generated <code>cjdroute.conf</code> file. </p>
<ul>
<li>The <code>cjdroute.conf</code> file is generated by the configure script </li>
<li>It is being launched by the init script which is run on the server start. </li>
<li>For persistency the file is stored in the <code>vpn_data</code> directory and used by the cjdns service. </li>
</ul>
<p>You can manually edit the file to add more cjdns peers.</p>
<div class="admonition info">
<p class="admonition-title">Note</p>
<p>Changing other parts of the configuration manually may end up breaking the service.</p>
<ul>
<li>Wathdog is configured to keep cjdns running all the time. If the service stops, the watchdog will restart it.</li>
<li>
<p>If cjdroute is for some reason stuck or frozen you can kill it by running </p>
<p><code>docker exec -it pkt-server killall cjdroute</code></p>
<p>and the watchdog will restart it.</p>
</li>
</ul>
</div>
<h3 id="anodevpn-server">AnodeVPN Server</h3>
<p>The server is running the AnodeVPN server to authorize clients and offer API access to the VPN services such as:</p>
<ul>
<li>
<p>Add domain to SNI proxy </p>
<p><code>http://[server]:8099/api/0.4/server/domain/add/</code></p>
<p><code>console
json { "domain": "example.com", "cjdnsIpv6": "fc00:0000:0000:0000:0000:0000:0000:0001" }</code></p>
</li>
<li>
<p>Remove domain from SNI proxy </p>
<p><code>http://[server]:8099/api/0.4/server/domain/remove/</code></p>
<p><code>console
json { "domain": "example.com", "cjdnsIpv6": "fc00:0000:0000:0000:0000:0000:0000:0001" }</code></p>
</li>
<li>
<p>Request new PKT address </p>
<p><code>http://[server]:8099/api/0.4/server/premium/address/</code></p>
<p><code>console
json {}</code></p>
</li>
<li>
<p>Request new client VPN certificates</p>
<p><code>http://[server]:8099/api/0.4/server/vpnaccess/</code></p>
<p><code>console
json { "address": "pkt1...." }</code></p>
</li>
</ul>
<p>For more details see the <a href="https://anode.co/#/" target="_blank">AnodeVPN</a></p>
<h3 id="ikev2-ipsec-vpn-server">IKEv2 Ipsec VPN Server</h3>
<p>The IKEv2 Ipsec VPN server is running on the server and is used to provide VPN services to clients with access to cjdns network.</p>
<p>For setting up the server the init script will launch the <code>vpn_configure.sh</code> if the <code>ikev2:enabled</code> flag is set to true, which will set up the server.</p>
<p>We also use the <code>ikev2.sh</code> script to add/remove clients through the AnodeVPN API. The files generated are copied in <code>server/vpnclients</code> directory which is mapped to <code>vpn_data/vpnclients/</code> on the docker host.</p>
<p>For more details look into the <code>setup-ipsec-vpn</code> documentation for configuring the server, managing clients and troubleshooting.</p>
<div class="admonition info">
<p class="admonition-title">NOTE</p>
<p>Unfortunately although IKEv2 clients can connect to the server from a Windows client and get VPN access, the clients are not able to access the CJDNS network. This is a known issue and we are working on a solution, for this reason we have added the OpenVPN server as an alternative for Windows users.</p>
</div>
<h3 id="openvpn-server">OpenVPN Server</h3>
<p>The openvpn is initialized by the init script if the <code>openvpn.enabled</code> flag is set to true in <code>config.json</code> and is used to provide VPN services to clients with access to cjdns network.</p>
<p>The server is configured using the <code>openvpn_configure.sh</code> which is used to generate the certificates needed.</p>
<p>Then for adding new clients the <code>createOpenVpnClient.sh</code> script is used by the AnodeVPN Server API to generate the client certificates and keys. The files are stored in the <code>vpn_data/vpnclients/</code> directory and can be used to connect to the server.</p>
<div class="admonition info">
<p class="admonition-title">NOTE</p>
<p>The OpenVPN server is running on the server and is used to provide VPN services to clients with access to cjdns network. This was added on top of the IKEv2 for Windows users to be able to access the cjdns network, but it can be used by any OpenVPN client on any platform.</p>
</div>
<h3 id="sni-proxy">SNI Proxy</h3>
<p>Proxies incoming HTTP and TLS connections based on the hostname contained in the initial request of the TCP session. This enables websites that are hosted on CJDNS network to become available via HTTPS name-based virtual hosting.</p>
<p>The SNI proxy will start if the <code>sniproxy.enabled</code> flag is set to true in the <code>config.json</code> file.</p>
<p>The sniproxy is using the <code>sniproxy.conf</code> file to route the requests to the correct server.</p>
<p>The server contains the default configuration for the sniproxy and is being edited by the <code>adddomain.sh</code> and <code>removedomain.sh</code> scripts which are used by the AnodeVPN API to add and remove domains respectively from the proxy.</p>
<p>For troubleshooting you can view the sniproxy logs. The access log is stored in <code>vpn_data/sniproxy-access.log</code> and the error log is stored in <code>vpn_data/sniproxy-error.log</code>.</p>

<ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
  <li class="last-updated-holder displayDate loading">
    <span class="last-updated-text">Last updated:</span>
    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date"></time>
  </li>
<!--
  <li class="readingTime">
    2 minutes to read
  </li>
-->
  <li class="contributors-holder">
    <span class="contributors-text">Contributors</span>
    <ul class="contributors" data-bi-name="contributors"></ul>
  </li>
</ul>

        <div class="md-footer-nav">
          <!-- Navigation links will be inserted here by custom-nav.js -->
        </div>
      </div>
      <div id="sidebar-toc" class="sidebar col-md-2">
        <nav id="toc" data-toggle="toc" class="sticky-top sticky-offset">
          <h4>Table of Contents</h4>
        </nav>
      </div>
    </div>
    </div><footer class="col-md-12">
  <nav class="container">
    <div class="row">
      <div class="col-md-5 col-sm-12">
		<a class="navbar-brand" href="../..">
          <img src="../../assets/logo.svg" alt="PKT Documentation">
		</a>
		<ul class="c-footer__logo_social nav flex-row ml-md-auto d-md-flex">
			<li class="c-footer__menu-item">
				<a href="https://pkt.chat" target="_blank" class="c-footer__menu-link"><span class="c-footer__menu-text"><img src="../../assets/pkt-chat.svg" alt="pkt.chat" width="24"></span></a>
			</li>
			<li class="c-footer__menu-item">
				<a href="https://www.youtube.com/c/PKTCash/" target="_blank" class="c-footer__menu-link"><span class="c-footer__menu-text"><img src="../../assets/youtube.svg" alt="Youtube" width="24"></span></a>
			</li>
			<li class="c-footer__menu-item">
				<a href="https://www.instagram.com/pktcash/" target="_blank" class="c-footer__menu-link"><span class="c-footer__menu-text"><img src="../../assets/instagram.svg" alt="Instagram" width="24"></span></a>
			</li>
			<li class="c-footer__menu-item">
				<a href="https://twitter.com/pktcash" target="_blank" class="c-footer__menu-link"><span class="c-footer__menu-text"><img src="../../assets/x.svg" alt="Twitter" width="24"></span></a>
			</li>
			<li class="c-footer__menu-item">
				<a href="https://discord.gg/bjJutHm9CN" target="_blank" class="c-footer__menu-link"><span class="c-footer__menu-text"><img src="../../assets/discord.svg" alt="Discord" width="24"></span></a>
			</li>
			<li class="c-footer__menu-item">
				<a href="https://github.com/pkt-cash/" target="_blank" class="c-footer__menu-link"><span class="c-footer__menu-text"><img src="../../assets/github.svg" alt="Github" width="24"></span></a>
			</li>
		</ul>
		<a href="https://github.com/cjdelisle/CJDNS-contact" target="_blank" class="c-footer__menu-link">©2024 PKT Cash | Privacy Policy</a>
      </div>
		<div class="col">
			<h4>Learn</h4>
			<a href="https://pkt.cash/mine" title="Mine" target="_blank">Mine</a>
			<a href="https://pkt.cash/utility" title="Utility" target="_blank">Utility</a>
			<a href="https://pkt.cash/pkt-network" title="PKT Network" target="_blank">PKT Network</a>
			<a href="https://pkt.cash/pkt-cash" title="PKT Cash" target="_blank">PKT Cash</a>
			<a href="https://docsend.com/view/ayf5d3tz5rymn8fv" title="PKT Deck" target="_blank">PKT Deck</a>
		</div>
		<div class="col">
			<h4>Develop</h4>
			<a href="https://pkt.cash/PacketCrypt-2020-09-04.pdf" title="Technical Docs" target="_blank">Technical Docs</a>
			<a href="https://pkt.cash/roadmap" title="Roadmap" target="_blank">Roadmap</a>
			<a href="https://pkt.cash/PacketCrypt-2020-09-04.pdf" title="Yellowpaper" target="_blank">Yellowpaper</a>
			<a href="https://pkt.cash/PKT_Network_v1.0_2021.02.01.pdf" title="Whitepaper" target="_blank">Whitepaper</a>
		</div>
		<div class="col">
			<h4>Network</h4>
			<a href="https://packetscan.io/" title="Explorer" target="_blank">Explorer</a>
			<a href="https://pkt.cash/wallet" title="Wallets" target="_blank">Wallets</a>
			<a href="https://pkt.cash/network-steward" title="Network Steward" target="_blank">Network Steward</a>
			<a href="https://pkt.cash/ecosystem" title="Ecosystem" target="_blank">Ecosystem</a>
			<a href="https://github.com/cjdelisle/cjdns" title="Cjdns" target="_blank">Cjdns</a>
		</div>
		<div class="col">
			<h4>Explore</h4>
			<a href="https://pkt.cash/community" title="Community" target="_blank">Community</a>
			<a href="https://crypto.pkt.cash/" title="Blog" target="_blank">Blog</a>
			<a href="https://pkt.cash/trademark" title="Trademark" target="_blank">Trademark</a>
			<a href="https://pkt.cash/brand" title="Brand" target="_blank">Brand</a>
		</div>
  </nav>
</footer>

    <script>
      var base_url = "../..",
          shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" defer></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" defer></script>
    <script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js" defer></script>
    <script src="../../js/base.js" defer></script>
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-toc-skip>Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Get all nav items
        const navItems = document.querySelectorAll('.md-nav__link');
        
        // Find the current page
        let currentPageIndex = -1;
        navItems.forEach((item, index) => {
            if (item.classList.contains('active')) {
                currentPageIndex = index;
            }
        });

        // Add previous and next links if current page is found
        if (currentPageIndex !== -1) {
            const navContainer = document.querySelector('.md-footer-nav');
            
            if (navContainer) {
                // Previous link
                if (currentPageIndex > 0) {
                    const prevItem = navItems[currentPageIndex - 1];
                    const prevLink = document.createElement('a');
                    prevLink.href = prevItem.href;
                    prevLink.innerHTML = 'Previous <span>'+prevItem.textContent +'</span>';
                    prevLink.className = 'md-footer-nav__link md-footer-nav__link--prev';
                    navContainer.appendChild(prevLink);
                }

                // Next link
                if (currentPageIndex < navItems.length - 1) {
                    const nextItem = navItems[currentPageIndex + 1];
                    const nextLink = document.createElement('a');
                    nextLink.href = nextItem.href;
                    nextLink.innerHTML = 'Next <span>'+nextItem.textContent +'</span>';
                    nextLink.className = 'md-footer-nav__link md-footer-nav__link--next';
                    navContainer.appendChild(nextLink);
                }
            }
        }
    });
    </script>
  </body>
</html>
